\chapter{拡張するツールの実装}\label{cha:Implementation}

本章では、拡張するツールの実装について説明する。
拡張するツールのシステム構成を図\ref{fig:system-architecture}に示す。
拡張するツールは、以下の6つの主要なコンポーネントで構成する。
\begin{itemize}
  \item プロジェクト管理部
  \item 解析部
  \item GUI要素生成部
  \item 変換部
  \item 描画部
  \item ユーザ操作監視部
\end{itemize}
以降、各コンポーネントの実装についてそれぞれ説明する。

\begin{figure}[tp]
  \centering
  \includegraphics[width=0.8\linewidth]{./images/system-architecture.png}
  \caption{拡張するツールのシステム構成図}
  \label{fig:system-architecture}
\end{figure}


\section{プロジェクト管理部}

プロジェクト管理部は、ユーザが操作するプロジェクト全体の状態を管理し、
ファイルの探索、読込、更新、および生成物の出力に関する以下の５つの処理を担う。
\begin{itemize}
  \item フォルダ・ファイルの探索処理
  \item ファイル読込処理
  \item 生成物（VDM++ファイル）の出力処理
  \item ファイル更新処理
  \item JSONファイル出力処理
\end{itemize}
\subsection{フォルダ・ファイルの探索処理}
フォルダ・ファイルの探索処理は、ユーザが選択したプロジェクトフォルダ配下を走査し、編集対象となるMarkdownファイルおよびフォルダ構造を取得し、
GUI上にツリー形式で表示するための内部データを構築する処理である。

ユーザがフォルダ選択捜査を行った際に、選択したフォルダパスを保持し、その直下および下位階層を再帰的に探索する。
探索では、まずフォルダ自信を登録し、その配下に存在するサブフォルダおよびMarkdownファイルを検出する。

探索結果は、ファイルパス、階層レベル、展開情報を持つデータ構造として保持し、表示の展開、折り畳み操作に応じて表示状態を動的に制御する。
\subsection{ファイル読込処理}
ファイル読込処理は、
ユーザがツリー上で選択したMarkdownファイルを対象として、
その内容を読み込み、
解析部（\ref{sec:ParsingComponent}節を参照）および変換部（\ref{sec:ConversionComponent}節を参照）
に必要な内部状態を初期化する処理である。

対象ファイルを選択すると、
プロジェクト管理部はファイル内容を読み込み、
Markdown文字列として内部に保持する。
この際、対応するJSONファイルが存在する場合には、
そこから座標情報を読み込み、
GUI要素の配置を復元する。
\subsection{生成物（VDM++ファイル）の出力処理}
生成物出力処理は、
Markdownで記述された仕様をVDM++形式に変換し、
外部ファイルとして保存する処理である。
本処理では、変換部（\ref{sec:ConversionComponent}節を参照）を利用してMarkdownからVDM++への変換を行い、
生成されたVDM++データを指定されたファイルパスに出力する。

入力として、変換部から受け取ったVDM++データを取得し、
出力先のファイルパスを指定する。
\subsection{ファイル更新処理}\label{sec:FileUpdateProcess}
ファイル更新処理は、
ユーザによる編集結果をプロジェクトファイルへ反映し、
必要に応じて関連ファイルの整合性を維持する処理である。
本処理の流れを以下に示す。
\begin{enumerate}
    \item ユーザの保存操作を検出する。
    \item 現在のMarkdownデータをMarkdownファイルとして保存する。
    \item 保存されたMarkdownデータを変換部へ渡し、VDM++データを生成する。
    \item 生成されたVDM++データをVDM++ファイルとして保存する。
\end{enumerate}
\subsection{JSONファイル出力処理}
JSONファイル出力処理は、
GUI要素の配置情報を永続化するための処理である。

GUI上で配置した各要素の座標情報は、
要素名と座標の組としてJSON形式に変換し、
対応するMarkdownファイルと同名のJSONファイルとして保存する。
このJSONファイルは、
仕様の論理構造には含まれない視覚的情報のみを保持するため，
Markdown本体の可読性や再利用性を損なわない。

次回ファイル読込時には、
このJSONファイルを参照することで
GUI要素の配置を復元できるため、
ユーザは編集状態を継続したまま作業を行うことが可能となる。

\section{解析部}\label{sec:ParsingComponent}
解析部は、Markdownにより記述された仕様記述を解析し、GUI表示および操作の基礎となる構造データを生成する処理部である。
本部では、Markdown の文法構造を直接解釈するのではなく，「画面」「操作」「遷移」「条件分岐」といった GUI 表現に対応する概念構造を抽出することを目的とする。

Markdown解析処理は、画面定義、タイムアウト定義、ボタン定義、イベント定義、および条件分岐定義を抽出し、
これらを表\ref{tb:GUIElement}に示すGUIElementとして構造化する処理である。
本処理の流れを図\ref{fig:parsing-flow}と以下に示す。

\begin{enumerate}
    \item 入力された Markdown データを改行で分割し、
    行配列として保持する。
    空行やコメント行については、
    後続の解析処理に影響しないため、
    判定対象外として扱う。

    \item 行配列を先頭から順に走査し、
    行頭の見出し記号（\# の個数）および
    特定の文字列に基づいて、
    現在解析中のセクション種別を判定する。
    セクション種別は内部状態として保持し、
    次の見出し行が出現するまで維持される。

    \item 画面定義セクションでは、
    見出し行から画面名を抽出し、
    Screen要素を生成する。
    生成したScreen要素は、
    以降に生成されるボタンやイベントを
    対応付けるための基準として保持する。

    \item タイムアウト定義セクションでは、
    行からタイムアウト時間を抽出し、
    Timeout要素を生成する。
    数値の抽出に失敗した場合でも、
    解析処理は中断せず、
    後続の行の解析を継続する。
    生成したTimeout要素は、
    後続のイベント解析で参照される。

    \item ボタン一覧セクションでは、
    箇条書き行からボタン名を抽出し、
    Button要素を生成する。
    生成したButton要素は、
    以降のイベント解析において
    名前によって参照される。

    \item イベント一覧セクションでは、
    「\textrightarrow」記号を含む行を対象として解析を行い、
    記号の前後から対象ボタン名および遷移先を抽出する。
    遷移先が画面名である場合は画面遷移イベントとして扱い、
    操作を示す記述である場合は
    Operation要素を生成して対応付ける。
    また、「タイムアウト」を示すイベントが検出された場合には、
    事前に生成されたTimeout要素を遷移先として参照し、
    タイムアウトイベントとして扱う。

    \item 条件分岐が記述されている場合には、
    行頭のインデント量に基づいて
    条件行とその下位に記述されたイベント行を対応付ける。
    条件行より深いインデントを持つ行を
    当該条件に属するイベントとして扱い、
    条件とイベントの関係を保持する。

    \item 上記の処理により生成した各要素は，
    解析の進行に応じて順次内部リストへ追加する。
    追加時には、
    要素間の対応関係
    （ScreenとButton、
    ButtonとEvent、
    条件と分岐先イベント）
    が設定される。

    \item 最終的に、
    内部リストに格納した要素群を、
    GUI要素生成部が利用可能な
    GUIElement データ列として返却する。
\end{enumerate}


\begin{table}[tb]
\centering
\caption{GUIElementデータ構造}
\label{tb:GUIElement}
\begin{tabular}{|l|l|p{7cm}|}
\hline
\textbf{属性名} & \textbf{型} & \textbf{説明}\\ 

\hline
Type & GuiElementType & ノードの種類（Screen, Button, Event, Timeout, Operation など） \\

\hline
Name & string & ノードの名称 \\

\hline
Target & string & 遷移先となるノード名 \\

\hline
X & float & ノードの X 座標 \\

\hline
Y & float & ノードの Y 座標 \\

\hline
Width & float & ノードの横幅 \\

\hline
Height & float & ノードの高さ \\

\hline
IsSelected & bool & ノードがユーザにより選択されているかどうか \\

\hline
IsFixed & bool & ドラッグによる移動が可能かどうか \\

\hline
Branches & List\textless EventBranch \textgreater & 条件分岐を表す分岐リスト \\

\hline
Branches.Condition & string & 分岐条件 \\

\hline
Branches.Target & string & 分岐条件成立時のイベント \\

\hline
IsBranch & bool & 分岐（Branches）を保持しているかどうか \\

\hline
\end{tabular}
\end{table}

\begin{figure}[tp]
  \centering
  \includegraphics[width=0.7\linewidth]{./images/kaiseki_frow.png}
  \caption{解析部の処理フロー}
  \label{fig:parsing-flow}

\end{figure}
\section{GUI要素生成部}\label{sec:GUIElementGenerationComponent}
解析部で抽出したGUIElementデータ列を基に、
画面上で操作可能なGUI要素群を生成する処理である。
本処理の目的は、
Markdownにより記述された仕様の論理構造を、
ユーザが直感的に把握、操作できる視覚的表現へと変換することである。

本コンポーネントでは、
画面（Screen）、ボタン（Button）、イベント（Event）などの
要素をそれぞれ対応するGUI要素として生成し、
以降の描画部（\ref{sec:DrawingComponent}節を参照）およびユーザ操作監視部（\ref{sec:UserOperationMonitoring}節を参照）に引き渡す。
GUI要素生成部は、
単なる要素の対応付けを行うのではなく、
\textbf{配置，サイズ，操作可否}といった
GUIとしての振る舞いを規則に基づいて決定する。

通常ノードの形状・寸法を表\ref{tab:gui_node_spec}に，
条件分岐における可視ノードの形状・寸法を表\ref{tab:gui_node_branch}に示す。
GUI要素の初期配置は、
要素種別ごとに定められた規則に従って決定する。
画面要素は一定間隔で縦方向に配置し、
複数画面が存在する場合でも
重なりが生じないようオフセットを付与する。
要素のサイズについても、
種別ごとに既定値を設定している。
生成したGUI要素には、
ユーザ操作に関する属性も付与する。
例えば、タイムアウト（Timeout）要素は1画面につき単一のものとして扱うため移動不可とし、
ボタンや遷移要素はドラッグ操作による移動を可能とする。
この操作可否の区別により、
ユーザが誤って画面構造全体を崩すことを防止している。
また、イベントを表すGUI要素については、
対象ボタンおよびイベントの関連付けを行い、
描画部において矢印として表現できるよう、
接続情報を内部に保持する。
本処理の流れを以下に示す。
\begin{enumerate}
    \item 入力されたGUIElementデータ列を先頭から走査する。
    \item Screen要素に対しては、ウィンドウ要素を生成し、画面名をラベルとして設定する。
    \item Button要素に対しては、ボタン要素を生成し、ボタン名をラベルとして設定する。
    \item Timeout要素に対しては、タイムアウト表示用のラベル要素を生成し、タイムアウト時間を表示する。
    \item Event要素に対しては、矢印要素を生成し、対象ボタンを関連付ける。
    \item 生成したGUI要素に対して、初期座標、サイズ、操作可否などのプロパティを設定する。
    \item 最終的に、生成したGUI要素リストを出力する。
\end{enumerate}

% 形状を表で表す（TikZを使わず、用語で明示する版）
\begin{table}[htbp]
\centering
\caption{GUI要素の描画仕様（単位：px）}
\label{tab:gui_node_spec}
\begin{tabular}{|l|l|c|c|p{4.5cm}|}
\hline
\textbf{要素} & \textbf{形状} & \textbf{幅} & \textbf{高} & \textbf{配置・備考} \\
 \hline
Screen
& 角丸矩形
& 160 & 45
& 左列に縦配置（間隔80）、移動可 \\
 \hline

Button
& 楕円
& 80 & 45
& Screen内に縦配置、移動可 \\
 \hline

Event
& 矩形
& 160 & 45
& 中列配置，条件分岐時は本体非表示、移動可 \\
 \hline

Timeout
& 楕円
& 112 & 45
& 左上固定配置，移動不可 \\
 \hline

Operation
& ひし形
& 160 & 45
& 右列配置，遷移先ノード \\
 \hline
\end{tabular}
\end{table}



\begin{table}[htbp]
\centering
\caption{条件分岐における可視ノードの描画仕様（単位：px）}
\label{tab:gui_node_branch}
\begin{tabular}{|l|l|c|c|p{4cm}|}
\hline
\textbf{要素} & \textbf{形状} & \textbf{幅} & \textbf{高} & \textbf{備考} \\
 \hline
Condition
& ダイヤモンド
& 176 & 50
& 分岐条件を表す可視ノード \\
 \hline

Target
& 矩形
& 152 & 36
& 分岐先を示す中間ノード \\
 \hline
\end{tabular}
\end{table}


\section{変換部}\label{sec:ConversionComponent}
変換部は，仕様記述の表現形式を相互に変換する処理部である。
本コンポーネントでは、MarkdownとVDM++の変換に加え、GUI操作結果をMarkdownへ反映する処理を担う。MarkdownからVDM++への変換処理については、既存のツール\cite{2VSG}を利用する。
GUI操作からMarkdownへの変換処理について以下に説明する
GUI操作からMarkdownへの変換処理は、GUI操作による編集結果を差分として反映するのではなく、
GUI要素の現在状態からMarkdownを全体再生成する方式を採用している。
この設計により、
編集履歴や操作順序に依存しない一貫した仕様記述を生成でき、
構造的不整合が生じることを防止している。

変換処理では,
まずGUI要素をその種別および関連関係に基づいて分類し,
仕様記述として出力する順序を決定する。
出力規則は\tool \cite{2vdm-spec-generator}のMarkdown仕様記述ルールに準拠しており、
画面定義、タイムアウト定義、ボタン一覧、イベント一覧、条件分岐の順に要素を出力する。
変換処理の結果として生成したMarkdownは、
プロジェクト管理部に引き渡し、
ファイル更新処理（\ref{sec:FileUpdateProcess}節を参照）により保存する。
これにより、
GUI上の編集操作と仕様記述との間に
常に一貫した対応関係が保たれる。
本処理の流れを以下に示す。
\begin{enumerate}
    \item 現在のGUI要素を走査する。
    \item 要素の種別と順序に基づいてMarkdownの構造を再構成する。
    \item 条件分岐をインデント付き箇条書きとして出力する。
    \item 生成したMarkdownテキストをプロジェクト管理部へ通知する。
\end{enumerate}
\section{描画部}\label{sec:DrawingComponent}
描画部は、
各GUI要素を外接矩形として扱い、
要素種別に応じた形状、寸法、および描画スタイルを適用する。
これらの寸法および形状は、
GUI要素生成部（\ref{sec:GUIElementGenerationComponent}節を参照）で定義された規則に基づいて決定しており、
通常ノードおよび条件分岐ノードについては、
それぞれ表\ref{tab:gui_node_spec}、
表\ref{tab:gui_node_branch}に示す仕様を用いる。
\subsection{初期描画処理}
初期描画処理は、GUI要素生成部から受け取ったGUI要素データをもとに、初期状態のGUI表示を生成する処理である。
本処理の流れを以下に示す。
\begin{enumerate}
    \item 描画領域（キャンバス）を初期化する。
    \item GUI要素データを走査し、各要素の種別を判定する。
    \item 要素種別に応じた描画形状を決定する。
    \item 各要素の座標情報をもとに、キャンバス上へノードを描画する。
    \item 遷移関係を表す要素については、対応するノード間を矢印で接続する。
    \item 描画要素の外接矩形を記録し、後続のヒットテストに利用できるよう保持する。
\end{enumerate}

\subsection{再描画処理}
再描画処理は、ユーザ操作や仕様変更に伴い、GUI表示を更新する処理である。
この処理により、仕様の変更が即座に視覚的に反映され、ユーザが最新の状態を把握できるようにする。
本処理の流れを以下に示す。
\begin{enumerate}
    \item 再描画要求を受理する。
    \item 更新対象となるGUI要素の状態（座標、選択状態等）を反映する。
    \item 描画領域をクリアする。
    \item 初期描画処理と同一の手順で全要素を再描画する。
    \item 選択中要素については、視覚的に強調表示を行う。
\end{enumerate}
\section{ユーザ操作監視部}\label{sec:UserOperationMonitoring}
ユーザ操作監視部は、GUI 上で発生するユーザ入力を監視し、GUI 要素の選択や配置変更を検出する処理部である。
本部の目的は、ユーザの直感的な操作を、仕様変更として正確に内部データへ反映することである。
\subsection{クリック操作監視処理}
クリック操作監視処理は、ユーザがGUI要素をクリックした際の選択操作を検出し、対応するGUI要素を選択状態に更新する処理である。
本処理の流れを以下に示す。
\begin{enumerate}
    \item クリック位置を取得する。
    \item 描画部が保持する描画要素の外接矩形を用いてヒットテストを行う。
    \item ヒットしたGUI要素を選択対象として決定する。
    \item 既存の選択状態を解除し、新たな選択状態を設定する。
    \item 選択状態の変更を描画部へ通知し、再描画を要求する。
\end{enumerate}
\subsection{ドラッグ操作監視処理}
ドラッグ操作監視処理は、ユーザがGUI要素をドラッグした際の配置変更操作を検出し、対応するGUI要素の座標を更新する処理である。
本処理の流れを以下に示す。
\begin{enumerate}
    \item 押下開始時に、対象GUI要素を確定する。
    \item 対象要素が移動可能かを判定する。
    \item ドラッグ中、ポインタ移動量に応じて要素座標を更新する。
    \item 移動中も随時再描画を行い、操作結果を即時反映する。
    \item 押下終了時に、配置規則を適用する。
    \item 最終座標を内部データとして確定する。
    \item 位置変更をプロジェクト管理部へ通知する。
\end{enumerate}